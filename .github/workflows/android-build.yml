name: Build Titan (Debug APK)

on:
  workflow_dispatch:
  push:
    paths:
      - 'TitanApp_Rebuild.zip'
      - '.github/workflows/android-build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Unzip project
        run: unzip -q TitanApp_Rebuild.zip -d TitanApp

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK components
        run: sdkmanager "platforms;android-34" "build-tools;34.0.0"

      # ---- Detect project dir (folder with settings.gradle* or fallback to one containing /app) ----
      - name: Detect Android project dir
        shell: bash
        run: |
          set -e
          D=$(dirname $(find TitanApp -maxdepth 3 -name "settings.gradle*" -print -quit || true))
          if [ -z "$D" ] || [ "$D" = "." ]; then
            D=$(find TitanApp -maxdepth 4 -type d -path "*/app" -print -quit | sed 's#/app$##')
          fi
          echo "PROJECT_DIR=$D" | tee -a $GITHUB_ENV
          test -n "$D" && echo "Detected PROJECT_DIR=$D"

      # ---- Print project tree so we can see layout on device ----
      - name: Print project tree (debug)
        shell: bash
        run: |
          echo "PROJECT_DIR=$PROJECT_DIR"
          ls -la "$PROJECT_DIR" || true
          ls -la "$PROJECT_DIR/app" || true
          echo "Gradle build files:"
          find "$PROJECT_DIR" -maxdepth 4 -type f -name "build.gradle*" -print || true

      # ---- Use wrapper if present; else download Gradle 8.7 ----
      - name: Use Gradle wrapper if available, else download Gradle 8.7
        shell: bash
        run: |
          if [ -f "$PROJECT_DIR/gradlew" ]; then
            echo "WRAPPER=1" >> $GITHUB_ENV
            chmod +x "$PROJECT_DIR/gradlew"
          else
            echo "WRAPPER=0" >> $GITHUB_ENV
            curl -L -o gradle.zip https://services.gradle.org/distributions/gradle-8.7-bin.zip
            unzip -q gradle.zip -d $HOME/gradle
            echo "$HOME/gradle/gradle-8.7/bin" >> $GITHUB_PATH
          fi

      # ---- Safely force Java/Kotlin 17 if app/build.gradle(.kts) exists ----
      - name: Force Java/Kotlin 17 in Gradle files (safe)
        shell: bash
        run: |
          set -euo pipefail
          APP="${PROJECT_DIR}/app"
          GRADLE_FILE=""
          if [[ -f "${APP}/build.gradle" ]]; then GRADLE_FILE="${APP}/build.gradle"; fi
          if [[ -z "$GRADLE_FILE" && -f "${APP}/build.gradle.kts" ]]; then GRADLE_FILE="${APP}/build.gradle.kts"; fi
          if [[ -z "$GRADLE_FILE" ]]; then
            echo "No app/build.gradle(.kts) found. Skipping patch."
            exit 0
          fi
          echo "Patching $GRADLE_FILE"
          # normalize to ASCII (mobile editors sometimes add weird chars)
          LC_ALL=C tr -cd '\11\12\15\40-\176' < "$GRADLE_FILE" > "$GRADLE_FILE.clean" && mv "$GRADLE_FILE.clean" "$GRADLE_FILE"
          # swap any 1.8 -> 17
          sed -i 's/JavaVersion\.VERSION_1_8/JavaVersion.VERSION_17/g' "$GRADLE_FILE"
          sed -i 's/sourceCompatibility *=[^0-9A-Za-z]*1\.8/sourceCompatibility JavaVersion.VERSION_17/g' "$GRADLE_FILE"
          sed -i 's/targetCompatibility *=[^0-9A-Za-z]*1\.8/targetCompatibility JavaVersion.VERSION_17/g' "$GRADLE_FILE"
          sed -i 's/jvmTarget *= *["'\''"]\?1\.8["'\''"]\?/jvmTarget = "17"/g' "$GRADLE_FILE"
          # ensure kotlinOptions exists with jvmTarget 17
          if ! grep -q "kotlinOptions" "$GRADLE_FILE"; then
            awk '
              BEGIN{ins=0}
              /android *\{/ && ins==0 { print; print "    kotlinOptions {"; print "        jvmTarget = \"17\""; print "    }"; ins=1; next }
              { print }
            ' "$GRADLE_FILE" > tmp && mv tmp "$GRADLE_FILE"
          fi

      # ---- Build ----
      - name: Build Debug APK
        shell: bash
        run: |
          set -e
          if [ "$WRAPPER" = "1" ]; then
            "$PROJECT_DIR/gradlew" -p "$PROJECT_DIR" --no-daemon assembleDebug
          else
            gradle -v
            gradle -p "$PROJECT_DIR" --no-daemon assembleDebug
          fi

      # ---- Upload whatever debug APK we find ----
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: titan-debug-apk
          path: |
            ${{ env.PROJECT_DIR }}/**/build/outputs/apk/debug/*.apk
          retention-days: 14
